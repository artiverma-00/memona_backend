-- Enable UUID generation
create extension if not exists "pgcrypto";
-- profiles table extends auth.users
-- Stores additional user data like role and avatar

create table public.profiles (
  id uuid references auth.users on delete cascade primary key,
  full_name text,
  avatar_url text,
  role text default 'user' check (role in ('user','admin')),
  created_at timestamp default now()
);

-- Enable RLS
alter table public.profiles enable row level security;
-- Stores metadata of uploaded images/videos/audio

create table public.media_files (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id) on delete cascade,
  public_id text not null,
  secure_url text not null,
  resource_type text check (resource_type in ('image','video','audio')),
  format text,
  bytes integer,
  duration numeric,
  created_at timestamp default now()
);

alter table public.media_files enable row level security;
-- Main memory storage table

create table public.memories (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id) on delete cascade,
  title text not null,
  description text,
  media_id uuid references public.media_files(id),
  voice_note_id uuid references public.media_files(id),
  location_lat numeric,
  location_lng numeric,
  location_name text,
  is_milestone boolean default false,
  is_public boolean default false,
  created_at timestamp default now()
);

alter table public.memories enable row level security;

-- Master tags table

create table public.tags (
  id uuid default gen_random_uuid() primary key,
  name text unique not null
);

-- Join table for many-to-many relationship

create table public.memory_tags (
  memory_id uuid references public.memories(id) on delete cascade,
  tag_id uuid references public.tags(id) on delete cascade,
  primary key (memory_id, tag_id)
);

alter table public.tags enable row level security;
alter table public.memory_tags enable row level security;
-- Albums table

create table public.albums (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id) on delete cascade,
  title text not null,
  description text,
  cover_media_id uuid references public.media_files(id),
  is_public boolean default false,
  created_at timestamp default now()
);

-- Join table between albums and memories

create table public.album_memories (
  album_id uuid references public.albums(id) on delete cascade,
  memory_id uuid references public.memories(id) on delete cascade,
  primary key (album_id, memory_id)
);

alter table public.albums enable row level security;
alter table public.album_memories enable row level security;
-- Allows shared album editing

create table public.collaborations (
  id uuid default gen_random_uuid() primary key,
  album_id uuid references public.albums(id) on delete cascade,
  owner_id uuid references public.profiles(id),
  collaborator_id uuid references public.profiles(id),
  role text default 'editor'
);

alter table public.collaborations enable row level security;
-- Additional milestone metadata

create table public.milestones (
  id uuid default gen_random_uuid() primary key,
  memory_id uuid references public.memories(id) on delete cascade,
  celebration_date date,
  reminder_enabled boolean default true
);

alter table public.milestones enable row level security;

-- Likes table

create table public.memory_likes (
  memory_id uuid references public.memories(id) on delete cascade,
  user_id uuid references public.profiles(id) on delete cascade,
  primary key (memory_id, user_id)
);

-- Comments table

create table public.memory_comments (
  id uuid default gen_random_uuid() primary key,
  memory_id uuid references public.memories(id) on delete cascade,
  user_id uuid references public.profiles(id),
  comment text,
  created_at timestamp default now()
);

alter table public.memory_likes enable row level security;
alter table public.memory_comments enable row level security;
-- Stores AI generated memory videos

create table public.ai_generated_videos (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id),
  title text,
  video_media_id uuid references public.media_files(id),
  created_at timestamp default now()
);

alter table public.ai_generated_videos enable row level security;
-- Exported PDF/ZIP records

create table public.exports (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id),
  file_url text,
  format text,
  created_at timestamp default now()
);

alter table public.exports enable row level security;
-- Used for admin analytics dashboard

create table public.activity_logs (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id),
  action text,
  metadata jsonb,
  created_at timestamp default now()
);

alter table public.activity_logs enable row level security;
-- Users can view and update their own profile
create policy "Users manage own profile"
on public.profiles
for all
using (auth.uid() = id);

-- Users manage their own memories
create policy "Users manage own memories"
on public.memories
for all
using (auth.uid() = user_id);

-- Public memories visible to everyone
create policy "Public memories visible"
on public.memories
for select
using (is_public = true);

-- Admin full access
create policy "Admin access memories"
on public.memories
for all
using (
  exists (
    select 1 from public.profiles
    where id = auth.uid()
    and role = 'admin'
  )
);

create policy "Users manage own albums"
on public.albums
for all
using (auth.uid() = user_id);

create policy "Users manage own media"
on public.media_files
for all
using (auth.uid() = user_id);

create policy "Users manage likes"
on public.memory_likes
for all
using (auth.uid() = user_id);

create policy "Users manage comments"
on public.memory_comments
for all
using (auth.uid() = user_id);
begin;

alter table if exists public.memories
  drop constraint if exists memories_user_id_fkey;


delete from public.memories where user_id is null;

alter table if exists public.memories
  alter column user_id set not null;

alter table if exists public.memories
  add constraint memories_user_id_fkey
  foreign key (user_id)
  references auth.users(id)
  on delete cascade;

create index if not exists idx_memories_user_id on public.memories(user_id);

alter table if exists public.memories enable row level security;

revoke all on public.memories from anon;
grant select, insert, update, delete on public.memories to authenticated;

drop policy if exists "memories_select_own" on public.memories;
drop policy if exists "memories_insert_own" on public.memories;
drop policy if exists "memories_update_own" on public.memories;
drop policy if exists "memories_delete_own" on public.memories;

create policy "memories_select_own"
on public.memories
for select
to authenticated
using (auth.uid() = user_id);

create policy "memories_insert_own"
on public.memories
for insert
to authenticated
with check (auth.uid() = user_id);

create policy "memories_update_own"
on public.memories
for update
to authenticated
using (auth.uid() = user_id)
with check (auth.uid() = user_id);

create policy "memories_delete_own"
on public.memories
for delete
to authenticated
using (auth.uid() = user_id);

commit;
